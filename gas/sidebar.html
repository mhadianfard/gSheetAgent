<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
      /**
       * Triggers the performAction function in the Google Apps Script.
       * This function handles success and failure responses from the script.
       */
      function applyChanges() {
        google.script.run
            .withSuccessHandler(function(response) {
                // Handle success response if needed
                console.log('Action performed successfully:', response);
            })
            .withFailureHandler(function(error) {
                // Check if the error message contains "Permission Denied"
                if (error.message.includes("PERMISSION_DENIED")) {
                    window.alert('Permission Denied: Please make sure you are not logged into more than one Google account in this browser.');
                } else {
                    window.alert('Error: ' + error.message);
                }
            })
            .performAction();
      }

      /**
       * Refreshes the sidebar content by calling the refreshSidebar function in the Google Apps Script.
       */
      function refresh() {
        google.script.run.refreshSidebar();
      }

      /**
       * Clears the textarea content.
       */
      function clearTextarea() {
        document.querySelector('textarea').value = '';
      }

      /**
       * Shows the thinking mode with a custom label.
       * @param {string} label - The label to display in the thinking mode.
       */
      function showThinkingMode(label) {
          document.getElementById('promptMode').style.display = 'none';
          document.getElementById('thinkingMode').style.display = 'block';
          document.getElementById('confirmationMode').style.display = 'none';
          document.getElementById('thinkingLabel').innerText = label;
      }

      /**
       * Switches the sidebar to Confirmation Mode, hiding the prompt and showing the confirmation buttons.
       */
      function submitPrompt() {
          // Show thinking mode with a custom label
          const label = "Thinking..."; // You can customize this label as needed
          showThinkingMode(label);

          // Get the user input from the textarea
          const instruction = document.querySelector('textarea').value;

          // Send a POST request to the /prompt/text endpoint
          fetch('http://localhost:5000/prompt/text', { // Adjust the URL as needed
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ instruction: instruction })
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Network response was not ok');
              }
              return response.json();
          })
          .then(data => {
              console.log('Success:', data);
              document.getElementById('thinkingMode').style.display = 'none';
              showConfirmationText(data.received_instruction); // Display the received instruction
          })
          .catch((error) => {
              console.error('Error:', error);
              alert('There was an error processing your request.');
          });
      }

      /**
       * Displays the confirmation text as HTML.
       * @param {string} htmlString - The HTML string to display in the confirmation area.
       */
      function showConfirmationText(htmlString) {
          document.getElementById('promptMode').style.display = 'none';
          document.getElementById('thinkingMode').style.display = 'none';
          const confirmationContainer = document.getElementById('confirmationText');
          confirmationContainer.innerHTML = '<p><strong>Here\'s what I\'ll be doing: </strong></p>' + htmlString;
          document.getElementById('confirmationMode').style.display = 'block';

          // Enable the Apply button after displaying the confirmation
          const applyButton = document.querySelector('.btn-success');
          applyButton.disabled = false;
      }

      /**
       * Switches the sidebar back to Prompt Mode, hiding the confirmation buttons and showing the prompt.
       */
      function cancel() {
        document.getElementById('confirmationMode').style.display = 'none';
        document.getElementById('promptMode').style.display = 'block';
        document.getElementById('thinkingMode').style.display = 'none'; // Hide thinking mode if cancelled
      }

      /**
       * Applies the changes and shows the thinking state.
       */
      function applyChanges() {
          // Show thinking mode with a custom label
          showThinkingMode("Applying changes...");

          // Call the Google Apps Script function to apply changes
          google.script.run
              .withSuccessHandler(function(response) {
                  // Hide thinking mode and return to prompt mode
                  document.getElementById('thinkingMode').style.display = 'none';
                  document.getElementById('promptMode').style.display = 'block';
                  google.script.run.displayToast('Changes applied successfully!');
              })
              .withFailureHandler(function(error) {
                  if (error.message.includes("PERMISSION_DENIED")) {
                      window.alert('Permission Denied: Please make sure you are not logged into more than one Google account in this browser.');
                  } else {
                    google.script.run.displayToast(error.message);
                  }
                  
                  // Hide thinking mode and return to prompt mode
                  document.getElementById('thinkingMode').style.display = 'none';
                  document.getElementById('promptMode').style.display = 'block';
              })
              .performAction(); // Call the function to perform the action

          function showToast(message, type) {
            
          }
      }
    </script>
  </head>
  <body style="background-color: #F0F4F9; min-height: 100vh; display: flex; flex-direction: column;">
    <div class="container flex-grow-1">
      <button class="btn btn-light btn-sm" style="position: absolute; right: 0px; top: 0px;" onclick="refresh()" title="Refresh Sidebar">
        <i class="fas fa-sync-alt"></i>
      </button>
      <h2 class="text-left mt-4 mb-4">gSheetAgent</h2>
      
      <!-- Prompt Mode -->
      <div id="promptMode">
        <p class="text-left">Tell me what changes you want to make to this spreadsheet:</p>
        <div style="position: relative;">
          <button class="btn btn-link p-0" style="position: absolute; top: 5px; right: 10px; background-color: transparent; color: gray;" onclick="clearTextarea()">
            <i class="fas fa-trash"></i>
          </button>
          <textarea id="instruction" class="form-control" rows="8" placeholder="Enter your wishes here..." style="padding-right: 40px;"></textarea>
        </div>
        <button class="btn btn-primary btn-block mt-3" onclick="submitPrompt()">Submit</button>
      </div>

      <!-- Thinking Mode -->
      <div id="thinkingMode" style="display: none;" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status" style="width: 100px; height: 100px; margin-top: 50px;">
        </div>
        <p id="thinkingLabel" class="text-center mt-3">Working...</p>
      </div>

      <!-- Confirmation Mode -->
      <div id="confirmationMode" style="display: none;">
        <div class="mt-3" style="height: 400px; overflow-y: auto;">
          <div id="confirmationText"></div> <!-- Container for confirmation text -->
        </div>
        <div class="mt-3">
          <div class="btn-group btn-group-justified w-100">
            <button class="btn btn-success" onclick="applyChanges()"><strong>Apply</strong></button>
            <button class="btn btn-secondary" onclick="cancel()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-4" style="color: lightgrey; font-size: 0.8em; position: relative; bottom: 0; width: 100%;">
      <p>Built with &hearts; by Mohsen Hadianfard</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html> 