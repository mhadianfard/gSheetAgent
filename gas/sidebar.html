<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
      /**
       * Triggers the performAction function in the Google Apps Script.
       * This function handles success and failure responses from the script.
       */
      function applyChanges() {
        google.script.run
            .withSuccessHandler(function(response) {
                // Handle success response if needed
                console.log('Action performed successfully:', response);
            })
            .withFailureHandler(function(error) {
                // Check if the error message contains "Permission Denied"
                if (error.message.includes("PERMISSION_DENIED")) {
                    window.alert('Permission Denied: Please make sure you are not logged into more than one Google account in this browser.');
                } else {
                    window.alert('Error: ' + error.message);
                }
            })
            .performAction();
      }

      /**
       * Refreshes the sidebar content by calling the refreshSidebar function in the Google Apps Script.
       */
      function refresh() {
        google.script.run.refreshSidebar();
      }

      /**
       * Clears the textarea content.
       */
      function clearTextarea() {
        document.querySelector('textarea').value = '';
      }

      /**
       * Switches the sidebar to Confirmation Mode, hiding the prompt and showing the confirmation buttons.
       */
      function submitPrompt() {
        // Show thinking mode
        document.getElementById('promptMode').style.display = 'none';
        document.getElementById('thinkingMode').style.display = 'block';

        // Get the user input from the textarea
        const instruction = document.querySelector('textarea').value;

        // Send a POST request to the /prompt/text endpoint
        fetch('http://localhost:5000/prompt/text', { // Adjust the URL as needed
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ instruction: instruction })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log('Success:', data);
          document.getElementById('thinkingMode').style.display = 'none';
          showConfirmationText(data.received_instruction); // Display the received instruction
        })
        .catch((error) => {
          console.error('Error:', error);
          alert('There was an error processing your request.');
        });
      }

      /**
       * Displays the confirmation text with a typewriter effect.
       * @param {string} text - The text to display in the confirmation area.
       */
      function showConfirmationText(htmlString) {
        const confirmationContainer = document.getElementById('confirmationText');
        confirmationContainer.innerHTML = ''; // Clear previous text
        document.getElementById('confirmationMode').style.display = 'block';

        // Disable the Apply button during typing
        const applyButton = document.querySelector('.btn-success');
        applyButton.disabled = true;

        // Create a virtual DOM structure
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const elements = Array.from(doc.body.childNodes);

        let currentIndex = 0;
        const speed = 10; // Speed of typing effect in milliseconds

        function typeWriter(element) {
          if (element.nodeType === Node.TEXT_NODE) {
            const text = element.textContent;
            let charIndex = 0;

            function typeChar() {
              if (charIndex < text.length) {
                confirmationContainer.innerHTML += text.charAt(charIndex);
                charIndex++;
                setTimeout(typeChar, speed);
              } else {
                // Move to the next element after finishing the current one
                currentIndex++;
                if (currentIndex < elements.length) {
                  typeWriter(elements[currentIndex]);
                } else {
                  // Enable the Apply button after typing is complete
                  applyButton.disabled = false;
                }
              }
            }

            typeChar(); // Start typing the current text node
          } else {
            // If it's an element node, process its children
            Array.from(element.childNodes).forEach(child => {
              typeWriter(child);
            });
          }
        }

        typeWriter(elements[currentIndex]); // Start the typewriter effect
      }

      /**
       * Switches the sidebar back to Prompt Mode, hiding the confirmation buttons and showing the prompt.
       */
      function cancel() {
        document.getElementById('confirmationMode').style.display = 'none';
        document.getElementById('promptMode').style.display = 'block';
        document.getElementById('thinkingMode').style.display = 'none'; // Hide thinking mode if cancelled
      }
    </script>
  </head>
  <body style="background-color: #F0F4F9; min-height: 100vh; display: flex; flex-direction: column;">
    <div class="container flex-grow-1">
      <button class="btn btn-light btn-sm" style="position: absolute; right: 0px; top: 0px;" onclick="refresh()" title="Refresh Sidebar">
        <i class="fas fa-sync-alt"></i>
      </button>
      <h2 class="text-left mt-4 mb-4">gSheetAgent</h2>
      
      <!-- Prompt Mode -->
      <div id="promptMode">
        <p class="text-left">Tell me what changes you want to make to this spreadsheet:</p>
        <div style="position: relative;">
          <button class="btn btn-link p-0" style="position: absolute; top: 5px; right: 10px; background-color: transparent; color: gray;" onclick="clearTextarea()">
            <i class="fas fa-trash"></i>
          </button>
          <textarea id="instruction" class="form-control" rows="8" placeholder="Enter your wishes here..." style="padding-right: 40px;"></textarea>
        </div>
        <button class="btn btn-primary btn-block mt-3" onclick="submitPrompt()">Submit</button>
      </div>

      <!-- Thinking Mode -->
      <div id="thinkingMode" style="display: none;" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status" style="width: 100px; height: 100px; margin-top: 50px;">
        </div>
        <p class="text-center mt-3">Thinking...</p>
      </div>

      <!-- Confirmation Mode -->
      <div id="confirmationMode" style="display: none;">
        <div class="mt-3" style="height: 400px; overflow-y: auto;">
          <div id="confirmationText"></div> <!-- Container for confirmation text -->
        </div>
        <div class="mt-3">
          <div class="btn-group btn-group-justified w-100">
            <button class="btn btn-success" onclick="applyChanges()"><strong>Apply</strong></button>
            <button class="btn btn-secondary" onclick="cancel()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-4" style="color: lightgrey; font-size: 0.8em; position: relative; bottom: 0; width: 100%;">
      <p>Built with &hearts; by Mohsen Hadianfard</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html> 