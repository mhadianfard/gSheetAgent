<script>
    /**
     * Triggers the performAction function in the Google Apps Script.
     * This function handles success and failure responses from the script.
     */
    function applyChanges() {
        google.script.run
            .withSuccessHandler(function(response) {
                // Handle success response if needed
                console.log('Action performed successfully:', response);
            })
            .withFailureHandler(function(error) {
                // Check if the error message contains "Permission Denied"
                if (error.message.includes("PERMISSION_DENIED")) {
                    window.alert('Permission Denied: Please make sure you are not logged into more than one Google account in this browser.');
                } else {
                    window.alert('Error: ' + error.message);
                }
            })
            .performAction();
    }

    /**
     * Refreshes the sidebar content by calling the refreshSidebar function in the Google Apps Script.
     */
    function refresh() {
        google.script.run.refreshSidebar();
    }

    /**
     * Clears the textarea content.
     */
    function clearTextarea() {
        document.querySelector('textarea').value = '';
    }

    /**
     * Shows the thinking mode with a custom label.
     * @param {string} label - The label to display in the thinking mode.
     */
    function showThinkingMode(label) {
        document.getElementById('promptMode').style.display = 'none';
        document.getElementById('thinkingMode').style.display = 'block';
        document.getElementById('confirmationMode').style.display = 'none';
        document.getElementById('thinkingLabel').innerText = label;
    }

    /**
     * Switches the sidebar to Confirmation Mode, hiding the prompt and showing the confirmation buttons.
     */
    function submitPrompt() {
        // Show thinking mode with a custom label
        const label = "Thinking..."; // You can customize this label as needed
        showThinkingMode(label);

        // Get the user input from the textarea
        const instruction = document.querySelector('textarea').value;

        // Send a POST request to the /prompt/text endpoint
        fetch('http://localhost:5000/prompt/text', { // Adjust the URL as needed
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ instruction: instruction })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            document.getElementById('thinkingMode').style.display = 'none';
            showConfirmationText(data.received_instruction); // Display the received instruction
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('There was an error processing your request.');
        });
    }

    /**
     * Displays the confirmation text as HTML.
     * @param {string} htmlString - The HTML string to display in the confirmation area.
     */
    function showConfirmationText(htmlString) {
        document.getElementById('promptMode').style.display = 'none';
        document.getElementById('thinkingMode').style.display = 'none';
        const confirmationContainer = document.getElementById('confirmationText');
        confirmationContainer.innerHTML = '<p><strong>Here\'s what I\'ll be doing: </strong></p>' + htmlString;
        document.getElementById('confirmationMode').style.display = 'block';

        // Enable the Apply button after displaying the confirmation
        const applyButton = document.querySelector('.btn-success');
        applyButton.disabled = false;
    }

    /**
     * Switches the sidebar back to Prompt Mode, hiding the confirmation buttons and showing the prompt.
     */
    function cancel() {
        document.getElementById('confirmationMode').style.display = 'none';
        document.getElementById('promptMode').style.display = 'block';
        document.getElementById('thinkingMode').style.display = 'none'; // Hide thinking mode if cancelled
    }

    /**
     * Applies the changes and shows the thinking state.
     */
    function applyChanges() {
        // Show thinking mode with a custom label
        showThinkingMode("Applying changes...");

        // Call the Google Apps Script function to apply changes
        google.script.run
            .withSuccessHandler(function(response) {
                // Hide thinking mode and return to prompt mode
                document.getElementById('thinkingMode').style.display = 'none';
                document.getElementById('promptMode').style.display = 'block';
                google.script.run.displayToast('Changes applied successfully!');
            })
            .withFailureHandler(function(error) {
                if (error.message.includes("PERMISSION_DENIED")) {
                    window.alert('Permission Denied: Please make sure you are not logged into more than one Google account in this browser.');
                } else {
                    google.script.run.displayToast(error.message);
                }
                
                // Hide thinking mode and return to prompt mode
                document.getElementById('thinkingMode').style.display = 'none';
                document.getElementById('promptMode').style.display = 'block';
            })
            .performAction(); // Call the function to perform the action
    }
</script>